# 从合同编码批量拉取飞书协同群聊ID — 需求文档（草稿）

版本：v0.1（草稿）
状态：待补充接口细节与QPM确认

## 1. 背景与目标

- **背景**：需要依据合同编码，依次调用合同相关接口，最终获取对应协同群聊的 `chatGroupId`，用于运营对账、治理、审计等场景。
- **目标**：
  - **输入**：一批合同编码（列表）。
  - **处理**：按“合同编码 → 合同ID → 协同ID → 群聊ID”的链路逐一查询，具备限流与重试能力，单合同内严格串行。
  - **输出**：生成 Excel 清单，字段包含：合同编码、合同ID、协同ID、群聊ID、状态与错误说明等。

## 2. 术语

- **合同编码**：`contract_number`
- **合同ID**：`contract_id`
- **协同ID**：`cooperation_id`
- **群聊ID**：`openChatId`
- **QPM**：每分钟请求数（Queries Per Minute）

## 3. 业务范围

- **在范围**：
  - 读取合同编码清单，调用三类接口，生成结果 Excel。
  - 过程限流、重试、日志与可观测性。
  - 断点续跑与幂等（同一合同可重复执行且不会产生重复结果）。
- **不在范围**：
  - 新建/修改合同或群聊。
  - 权限开通、账号体系调整。

## 4. 输入与输出

- **输入**：
  - TXT 文本文件（UTF-8），一行一个 `contract_number`；
  - 文件路径通过配置文件指定（见第 12 章）。
- **配置文件**：
  - 使用 `config.yaml` 指定输入/输出路径、鉴权与限流重试等参数；示例见第 12 章。
- **输出（Excel）**：
  - 最小字段集（必须）：`contract_number`、`contract_id`、`cooperation_id`、`openChatId`、`status`、`error_message`。

## 5. 流程设计（单合同串行，合同间可控并发）

- **总体约束**：同一合同的三个步骤严格串行；默认合同间并发度为 1（确保“每个流程完成后再进入下一个合同”）。如后续允许提升吞吐，可通过配置提高并发度，但需满足各接口 QPM 限制。
- **步骤**：
  1. 通过“合同搜索接口”以 `contract_number` 查询，解析获得 `contract_id`。
  2. 使用 `contract_id` 调“合同详情 workflow/composition/contractAndTask”，解析获得 `cooperation_id`。
  3. 使用 `cooperation_id` 调“协同详情 cooperation/info”，解析获得 `openChatId`。
  4. 汇总行结果并落盘（Excel/中间态）。

## 6. API 与鉴权

### 6.0 鉴权：Tenant Access Token（获取 OpenAPI Token）

- **Path/Method**：POST https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal
- **鉴权**：请求体包含 `app_id`、`app_secret`（来自应用配置）；无需 Cookie。
- **请求示例**：
  ```bash
  curl --location 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal' \
  --header 'Content-Type: application/json' \
  --data '{
      "app_id": "${APP_ID}",
      "app_secret": "${APP_SECRET}"
  }'
  ```
- **响应取值**：`tenant_access_token` 路径：`$.tenant_access_token`；`expire` 路径：`$.expire`（秒）。
- **说明**：程序需缓存 Token 并在过期前刷新；所有 OpenAPI 调用通过 Header `Authorization: Bearer ${TENANT_ACCESS_TOKEN}` 传递。

### 6.1 合同搜索接口（contract search）

- **Path/Method**：POST https://open.feishu.cn/open-apis/contract/v1/contracts/search
- **鉴权**：`Authorization: Bearer ${TENANT_ACCESS_TOKEN}`；`Content-Type: application/json`
- **请求示例**：
  ```bash
  curl --location 'https://open.feishu.cn/open-apis/contract/v1/contracts/search' \
  --header 'Authorization: Bearer ${TENANT_ACCESS_TOKEN}' \
  --header 'Content-Type: application/json' \
  --data '{
      "page_size": 50,
      "contract_number": "<contract_number>"
  }'
  ```
- **关键入参**：`contract_number`（字符串，合同编码），`page_size`（整数）。
- **响应取值**：`contract_id` 的 JSON 路径：`$.data.items[0].contract_id` 
- **常见错误码**：429（限流）、401/403（鉴权）、4xx（参数）、5xx（服务）等

### 6.2 合同详情：workflow/composition/contractAndTask

- **Path/Method**：GET https://contract.feishu.cn/clm/api/workflow/composition/contractAndTask?contractId=${CONTRACT_ID}&withDocVersion=true
- **鉴权**：Cookie（ `session`）来自应用配置；`Accept: application/json`。
- **请求示例**：
  ```bash
  curl --location 'https://contract.feishu.cn/clm/api/workflow/composition/contractAndTask?contractId=${CONTRACT_ID}&withDocVersion=true' \
  --header 'Accept: application/json'
  # Cookie 通过运行环境安全注入：session=...
  ```
- **响应取值**：`cooperation_id` 的 JSON 路径：`$.data.contract.contractInfo.cooperationId`。
- **常见错误码**：同上；另注意 401/403（Cookie 失效/权限不足）。

### 6.3 协同详情：cooperation/info

- **Path/Method**：GET https://contract.feishu.cn/clm/api/cooperation/info?cooperationId=${COOPERATION_ID}
- **鉴权**：Cookie（ `session`）来自应用配置；`Accept: application/json`。
- **请求示例**：
  ```bash
  curl --location 'https://contract.feishu.cn/clm/api/cooperation/info?cooperationId=${COOPERATION_ID}' \
  --header 'Accept: application/json'
  # Cookie 通过运行环境安全注入：session=...
  ```
- **响应取值**：群聊 ID 的 JSON 路径：`$.data.openChatId`。
- **常见错误码**：同上；另注意 401/403（Cookie 失效/权限不足）。

## 7. 业务规则

- **数据缺失**：
  - 未找到合同：`status=NOT_FOUND_CONTRACT`。
  - 无协同：`status=NO_COOPERATION`，`cooperation_id=null`。
  - 无群聊：`status=NO_CHAT_GROUP`，`openChatId=null`。
- **鉴权/权限不足**：`status=AUTH_FAILED` 或 `PERMISSION_DENIED`，保留已完成上游字段。

## 8. 限流与重试策略

- **总体原则**：遵守平台限流；单合同串行；接口级与全局级双层限流。
- **默认 QPM（建议值，待确认，可配置）**：
  - `contract_search_qpm = 60`
  - `contract_composition_qpm = 60`
  - `cooperation_info_qpm = 60`
  - `global_qpm = 60`
- **限流实现**：令牌桶/漏桶；当令牌不足时等待（记录 `rateLimitWaitMs`）。
- **并发度**：`concurrency=1`（默认）。如需提升，`concurrency ≤ floor(global_qps / pipeline_qps)`，并确保各接口 QPM 不被突破。
- **超时**：每次调用超时 `8s`（可配置 5–10s）。
- **可重试错误**：HTTP 429、5xx、网络超时、临时连接失败。
- **不可重试错误**：401/403、4xx 参数校验失败、业务确定性失败（如多结果歧义）。
- **重试策略**：指数退避 + 抖动
  - `baseDelay=500ms`、`factor=2`、`jitter=±20%`、`maxDelay=10s`、`maxRetries=3`。

## 9. 日志与可观测

- **日志级别**：DEBUG/INFO/WARN/ERROR（DEBUG 可运行时开关）。
- **结构化字段**：
  - `traceId`/`requestId`、`step`（SEARCH/COMPOSITION/COOP_INFO）、`attempt`、`elapsedMs`、`httpStatus`、`errorCode`、`errorMessage`。
  - 业务键：`contract_number`、`contract_id`、`cooperation_id`、`openChatId`。
  - 限流/重试：`rateLimitWaitMs`、`retryCount`。
- **关键日志点**：
  - 每步开始/成功/失败各一条。
  - 命中限流与每次重试均记录（含退避时长）。
  - 批次汇总：成功数/失败数、各原因分布、耗时分位（p50/p95）。
- **指标（可选）**：
  - 成功率（按合同）= 成功行数/总行数。
  - 各步骤耗时、429 次数、平均重试次数、失败原因 TopN。

## 10. Excel 输出设计

- **文件名**：`contract_chat_mapping.xlsx`（可配置）。
- **列与顺序**：
  1. `contract_number`
  2. `contract_id`
  3. `cooperation_id`
  4. `openChatId`
  5. `status`
  6. `error_code`（可选）
  7. `error_message`
- **字段规则**：
  - `openChatId` 可为空；错误时尽量保留上游已解析字段。
  - 状态枚举建议：`SUCCESS`/`NOT_FOUND_CONTRACT`/`AMBIGUOUS`/`NO_COOPERATION`/`NO_CHAT_GROUP`/`AUTH_FAILED`/`PERMISSION_DENIED`/`RETRY_EXCEEDED`/`UNKNOWN_ERROR`。


## 12. 配置项（示例）

- **接口**：鉴权方式与凭证位置（Header/Cookie）。
- **QPM**：`contract_search_qpm`、`contract_info_qpm`、`cooperation_info_qpm`、`global_qpm`。
- **重试**：`timeoutMs`、`maxRetries`、`baseDelayMs`、`maxDelayMs`、`jitter`。
- **并发**：`concurrency`（默认 1）。
- **输出**：文件路径、是否拆分失败清单。
- **日志**：级别、是否输出到文件/控制台、是否采集指标。
- **配置文件**：推荐使用 `config.yaml`，不需要使用环境变量：
  ```yaml
  files:
    input_txt: ./input/contracts.txt
    output_excel: ./output/contract_openChatId.xlsx
    log_file: ./logs/run.log
  auth:
    app_id: ""
    app_secret: ""
    cookies:
      session: ""        # 仅用于 contract.feishu.cn 的 CLM 接口
  rate_limit:
    global_qpm: 60
    contract_search_qpm: 60
    contract_info_qpm: 60
    cooperation_info_qpm: 60
    concurrency: 1
  retry:
    timeout_ms: 8000
    max_retries: 3
    base_delay_ms: 500
    max_delay_ms: 10000
    jitter: 0.2
  ```

## 13. 安全与合规

- **凭证管理**：硬编码。
- **日志脱敏**：不脱敏。
- **最小权限**：仅授予读取所需接口权限。
- **配置与仓库**：提供 `config.example.yaml` 模板；实际 `config.yaml` 不应提交到仓库，应加入忽略列表。

## 14. 性能与容量评估（初稿）

- **估算**：默认 `global_qpm=60`、单合同 3 次请求，理论吞吐约 `20 合同/分钟`（不计重试与限流等待）。
- **SLA 建议**：
  - 可用性：≥ 99.9%（依赖外部接口稳定性）。
  - 正确性：对存在数据的合同，字段解析准确率 ≥ 99%。
  - 超时控制：单合同默认 ≤ 30 秒（含重试）。

## 15. 验收标准

- **功能**：
  - 给定样例合同编码集，输出 Excel 与人工核对一致。
  - 无协同/无群聊/多结果等场景按规则正确标注 `status` 与错误说明。
- **鲁棒性**：
  - 触发 429/5xx 时按策略重试并最终收敛；不可重试错误不重试。
  - 断点续跑与幂等生效，重复执行不会产生重复记录。
- **性能**：
  - 在约定 QPM 下，处理吞吐与耗时达到预期（按批量规模评估）。

## 16. 风险与依赖

- **外部依赖**：接口稳定性、权限与字段变更风险。
- **配额变更**：QPM 调整需及时同步策略与配置。
- **数据质量**：合同编码不规范、历史旧数据字段缺失。

## 17. 待你确认/补充

- **接口示例**：三类接口的调用示例、鉴权、入参与出参字段路径、错误码集合。
- **QPM**：各接口与全局可用配额与建议阈值。
- **规则**：合同多结果时的最终裁决规则、对无协同/无群聊的业务解释。
- **规模**：批量规模（单批与总量）、期望 SLA 与完成时限。

## 18. 伪代码（流程示意）

```pseudo
for code in contract_numbers:
  start_time = now()
  status = "INIT"; err = None; retry_total = 0
  contract_id = coop_id = chat_id = None

  # Step1: contract search
  with rate_limit(contract_search_qpm):
    contract_id, retry1, err = search_contract_id(code)
  retry_total += retry1
  if err:
    status = classify(err)  # NOT_FOUND_CONTRACT / AMBIGUOUS / AUTH_FAILED / ...
    write_row(code, contract_id, coop_id, chat_id, status, err, retry_total, now()-start_time)
    continue

  # Step2: composition
  with rate_limit(contract_composition_qpm):
    coop_id, retry2, err = get_cooperation_id(contract_id)
  retry_total += retry2
  if err:
    status = classify(err)  # NO_COOPERATION / AUTH_FAILED / ...
    write_row(code, contract_id, coop_id, chat_id, status, err, retry_total, now()-start_time)
    continue

  # Step3: cooperation info
  with rate_limit(cooperation_info_qpm):
    chat_id, retry3, err = get_openChatId(coop_id)
  retry_total += retry3
  if err:
    status = classify(err)  # NO_CHAT_GROUP / AUTH_FAILED / ...
  else:
    status = "SUCCESS"

  write_row(code, contract_id, coop_id, chat_id, status, err, retry_total, now()-start_time)
```

—— 以上为草稿结构，待你提供接口调用示例、入参/出参字段路径与错误码后，我将把占位内容补齐并细化 QPM 与日志示例。 

